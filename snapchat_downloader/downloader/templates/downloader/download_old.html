<!DOCTYPE html>
<html>
<head>
    <title>Download Snapchat Memories</title>
    <script>
        function downloadMemory(url, filename, year, month) {
            var parts = url.split("?");
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", parts[0], true);
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    var blob = new Blob([xhttp.responseText], { type: 'application/octet-stream' });
                    var link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;

                    // Create year and month folders if they don't exist
                    var yearFolder = year;
                    var monthFolder = year + "/" + month;
                    var fileFullPath = monthFolder + "/" + filename;

                    // Trigger the browser's download functionality
                    link.click();
                } else if (xhttp.readyState == 4 && xhttp.status >= 400) {
                    console.error("Oops! Something went wrong. Status: " + xhttp.status);
                }
            };
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhttp.send(parts[1]);
        }

        function downloadSelectedMemories() {
            var selectedYears = Array.from(document.querySelectorAll('input[name="selected_years"]:checked')).map(function (checkbox) {
                return checkbox.value;
            });
            console.log("Selected Years:", selectedYears);

            var selectedMonths = Array.from(document.querySelectorAll('input[name="selected_months"]:checked')).map(function (checkbox) {
                return checkbox.value;
            });
            console.log("Selected Months:", selectedMonths);

            // Send an AJAX request to retrieve the selected links in batches
            var batchSize = 100; // Adjust the batch size as needed
            var currentBatch = 0;

            function downloadBatch() {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/download/');
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        var selected_links = response.selected_links;
                        console.log("Selected Links (Batch " + currentBatch + "):", selected_links);

                        // Process the selected links and download the media files
                        for (var i = 0; i < selected_links.length; i++) {
                            var linkHtml = selected_links[i];
                            var linkElement = document.createElement('div');
                            linkElement.innerHTML = linkHtml;
                            var linkAnchor = linkElement.querySelector('a');
                            if (linkAnchor) {
                                var linkHref = linkAnchor.getAttribute('href');
                                var url = linkHref.match(/downloadMemories\('(.+?)'\)/)[1];
                                var dateMatch = url.match(/ts=(\d+)/);
                                if (dateMatch) {
                                    var timestamp = parseInt(dateMatch[1]);
                                    var date = new Date(timestamp);
                                    var year = date.getFullYear().toString();
                                    var month = (date.getMonth() + 1).toString().padStart(2, '0');
                                    var filename = "memory_" + (currentBatch * batchSize + i + 1) + ".jpg";
                                    console.log("Downloading:", url, filename);
                                    downloadMemory(url, filename, year, month);
                                } else {
                                    console.log("Date not found in URL:", url);
                                }
                            } else {
                                console.log("Link not found in HTML:", linkHtml);
                            }
                        }

                        currentBatch++;
                        if (currentBatch * batchSize < response.total_links) {
                            // More batches to download
                            downloadBatch();
                        } else {
                            console.log("All batches downloaded");
                        }
                    } else {
                        console.error('Error:', xhr.statusText);
                    }
                };
                xhr.onerror = function () {
                    console.error('Request failed');
                };
                xhr.send(JSON.stringify({
                    years: selectedYears,
                    months: selectedMonths,
                    offset: currentBatch * batchSize,
                    limit: batchSize
                }));
            }

            downloadBatch();
        }
    </script>
</head>
<body>
    <h1>Select Snapchat Memories to Download</h1>
    <form>
        {% csrf_token %}
        {% if links_count %}
            <ul>
            {% for year, months in links_count.items %}
                <li>
                    <input type="checkbox" name="selected_years" value="{{ year }}"> {{ year }}
                    <ul>
                    {% for month, count in months.items %}
                        <li>
                            <input type="checkbox" name="selected_months" value="{{ year }}-{{ month }}"> {{ month }} ({{ count }} media files)
                        </li>
                    {% endfor %}
                    </ul>
                </li>
            {% endfor %}
            </ul>
            <button type="button" onclick="downloadSelectedMemories()">Download Selected</button>
        {% else %}
            <p>No memories found.</p>
        {% endif %}
    </form>
</body>
</html>